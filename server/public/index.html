<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Story Reader</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container" id="app">
  <div class="loading-screen" id="loading">Chargement de l'histoire...</div>
</div>

<div class="new-chapter-toast" id="toast">
  Nouveau chapitre disponible — cliquer pour voir
</div>

<div class="menu-overlay" id="menu-overlay"></div>
<button class="menu-btn" id="menu-btn">&#9776;</button>
<aside class="menu-panel" id="menu-panel">
  <div class="menu-section">
    <h3 class="menu-heading">Chapitres</h3>
    <ul class="chapter-list" id="chapter-list"></ul>
  </div>
  <div class="menu-section" id="media-section">
    <h3 class="menu-heading">Médias</h3>
    <label class="media-toggle">
      <input type="checkbox" id="media-toggle" checked>
      <span class="toggle-slider"></span>
      <span class="toggle-label">Images & audio</span>
    </label>
    <label class="media-toggle">
      <input type="checkbox" id="autoplay-toggle" checked>
      <span class="toggle-slider"></span>
      <span class="toggle-label">Lecture auto</span>
    </label>
  </div>
  <div class="menu-section" id="voice-section" style="display:none">
    <h3 class="menu-heading">Voix</h3>
    <div class="voice-select-menu" id="voice-select-menu"></div>
  </div>
  <div class="menu-section" id="image-model-section" style="display:none">
    <h3 class="menu-heading">Mod&#232;le image</h3>
    <div class="voice-select-menu" id="image-model-menu"></div>
  </div>
</aside>

<script>
// --- State ---
let story = null;
let currentIndex = 0;
let audio = null;
let isPlaying = false;
let audioLoaded = false;
let mediaEnabled = true;
let autoplayEnabled = true;
let currentVoice = '';
let allVoices = [];
let currentImageModel = '';
let allImageModels = [];

const app = document.getElementById('app');
const toast = document.getElementById('toast');
const menuOverlay = document.getElementById('menu-overlay');
const menuBtn = document.getElementById('menu-btn');
const menuPanel = document.getElementById('menu-panel');
const mediaToggle = document.getElementById('media-toggle');

// --- Menu ---
function toggleMenu() {
  menuOverlay.classList.toggle('open');
  menuPanel.classList.toggle('open');
}

menuBtn.addEventListener('click', toggleMenu);
menuOverlay.addEventListener('click', toggleMenu);

function updateChapterList() {
  const list = document.getElementById('chapter-list');
  if (!story || !list) return;
  list.innerHTML = story.chapters.map((ch, i) =>
    `<li class="${i === currentIndex ? 'active' : ''}" data-index="${i}">${ch.title}</li>`
  ).join('');
  list.querySelectorAll('li').forEach(li => {
    li.addEventListener('click', () => {
      renderChapter(parseInt(li.dataset.index));
      toggleMenu();
    });
  });
}

function updateMediaToggle() {
  mediaToggle.checked = mediaEnabled;
}

const autoplayToggle = document.getElementById('autoplay-toggle');
autoplayToggle.addEventListener('change', () => {
  autoplayEnabled = autoplayToggle.checked;
});

mediaToggle.addEventListener('change', async () => {
  mediaEnabled = mediaToggle.checked;
  await fetch('/api/media-enabled', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ enabled: mediaEnabled }),
  });
  renderChapter(currentIndex);
  updateVoiceMenu();
  updateImageModelMenu();
});

function updateVoiceMenu() {
  const section = document.getElementById('voice-section');
  const container = document.getElementById('voice-select-menu');
  if (!section || !container) return;
  if (!mediaEnabled || allVoices.length < 2) {
    section.style.display = 'none';
    return;
  }
  section.style.display = '';
  container.innerHTML = allVoices.map(v =>
    `<button class="voice-chip ${v.id === currentVoice ? 'active' : ''}" data-voice="${v.id}">${v.label}</button>`
  ).join('');
  container.querySelectorAll('.voice-chip').forEach(btn => {
    btn.addEventListener('click', async () => {
      currentVoice = btn.dataset.voice;
      await fetch('/api/voice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ voice: currentVoice }),
      });
      updateVoiceMenu();
      loadChapterAudio(currentIndex);
    });
  });
}

function updateImageModelMenu() {
  const section = document.getElementById('image-model-section');
  const container = document.getElementById('image-model-menu');
  if (!section || !container) return;
  if (!mediaEnabled || allImageModels.length < 2) {
    section.style.display = 'none';
    return;
  }
  section.style.display = '';
  container.innerHTML = allImageModels.map(m =>
    `<button class="voice-chip ${m.id === currentImageModel ? 'active' : ''}" data-model="${m.id}">${m.label}</button>`
  ).join('');
  container.querySelectorAll('.voice-chip').forEach(btn => {
    btn.addEventListener('click', async () => {
      currentImageModel = btn.dataset.model;
      await fetch('/api/image-model', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: currentImageModel }),
      });
      updateImageModelMenu();
      loadChapterImage(currentIndex);
    });
  });
}

// --- Icons ---
const PLAY_ICON = '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>';
const PAUSE_ICON = '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';

// --- Load story ---
async function loadStory() {
  const res = await fetch('/api/story');
  story = await res.json();
  mediaEnabled = story.mediaEnabled !== false;
  currentVoice = story.currentVoice;
  allVoices = story.voices || [];
  currentImageModel = story.currentImageModel || '';
  allImageModels = story.imageModels || [];
  document.title = story.storyTitle + ' — Story Reader';
  updateChapterList();
  updateMediaToggle();
  updateVoiceMenu();
  updateImageModelMenu();
  renderChapter(0);
}

// --- Render ---
function renderChapter(index) {
  currentIndex = index;
  const ch = story.chapters[index];

  // Stop any playing audio
  if (audio) {
    audio.pause();
    audio.src = '';
    audio = null;
  }
  isPlaying = false;
  audioLoaded = false;

  app.innerHTML = `
    <header class="story-header">
      <h1 class="story-title">${story.storyTitle}</h1>
      ${story.storySubtitle ? `<p class="story-subtitle">${story.storySubtitle}</p>` : ''}
    </header>

    ${mediaEnabled ? `
    <div class="chapter-image-wrapper">
      <div class="image-placeholder" id="img-placeholder"></div>
      <img class="chapter-image" id="chapter-img" alt="">
      <div class="image-error" id="img-error" style="display:none"></div>
    </div>
    <div class="audio-player" id="audio-player">
      <div class="audio-controls">
        <button class="play-btn" id="play-btn" disabled>${PLAY_ICON}</button>
        <div class="audio-loading" id="audio-status">Chargement de la narration...</div>
      </div>
    </div>
    ` : ''}

    <h2 class="chapter-title">${ch.title}</h2>
    <div class="chapter-text">${ch.htmlContent}</div>

    <nav class="navigation">
      <button class="nav-btn" id="prev-btn" ${index === 0 ? 'disabled' : ''}>&#8592; Precedent</button>
      <span class="nav-indicator">Chapitre ${index + 1} / ${story.chapters.length}</span>
      <button class="nav-btn" id="next-btn" ${index >= story.chapters.length - 1 ? 'disabled' : ''}>Suivant &#8594;</button>
    </nav>
  `;

  // Navigation
  document.getElementById('prev-btn').addEventListener('click', () => {
    if (currentIndex > 0) renderChapter(currentIndex - 1);
  });
  document.getElementById('next-btn').addEventListener('click', () => {
    if (currentIndex < story.chapters.length - 1) renderChapter(currentIndex + 1);
  });

  // Load media (unless disabled)
  if (mediaEnabled) {
    loadChapterImage(index);
    loadChapterAudio(index);
  }

  // Update menu state
  updateChapterList();

  // Scroll to top
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// --- Image loading ---
async function loadChapterImage(index) {
  const img = document.getElementById('chapter-img');
  const placeholder = document.getElementById('img-placeholder');
  const errorEl = document.getElementById('img-error');
  const wrapper = img?.closest('.chapter-image-wrapper');

  if (!img) return;

  // Remove any existing model selector
  const oldSelector = wrapper?.parentElement?.querySelector('.image-model-selector');
  if (oldSelector) oldSelector.remove();

  try {
    const res = await fetch(`/api/chapter/${index}/image?model=${encodeURIComponent(currentImageModel)}`);
    if (!res.ok) throw new Error('Image generation failed');

    // Read cached models from header
    let cachedModels = [];
    try { cachedModels = JSON.parse(res.headers.get('X-Cached-Models') || '[]'); } catch {}

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    img.onload = () => {
      img.classList.add('loaded');
      placeholder.classList.add('hidden');
      URL.revokeObjectURL(url);
    };
    img.src = url;

    // Show inline model chips below image when multiple cached models exist
    if (cachedModels.length >= 2 && wrapper) {
      const chips = cachedModels.map(m => {
        const label = allImageModels.find(am => am.id === m)?.label || m;
        return `<button class="voice-chip ${m === currentImageModel ? 'active' : ''}" data-model="${m}">${label}</button>`;
      }).join('');
      const selector = document.createElement('div');
      selector.className = 'image-model-selector';
      selector.innerHTML = chips;
      wrapper.after(selector);
      selector.querySelectorAll('.voice-chip').forEach(btn => {
        btn.addEventListener('click', async () => {
          currentImageModel = btn.dataset.model;
          await fetch('/api/image-model', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ model: currentImageModel }),
          });
          updateImageModelMenu();
          loadChapterImage(index);
        });
      });
    }
  } catch (err) {
    placeholder.classList.add('hidden');
    errorEl.textContent = 'Illustration indisponible';
    errorEl.style.display = 'flex';
  }
}

// --- Audio loading ---
async function loadChapterAudio(index) {
  const player = document.getElementById('audio-player');
  if (!player) return;

  // Stop current audio
  if (audio) {
    audio.pause();
    audio.src = '';
    audio = null;
  }
  isPlaying = false;
  audioLoaded = false;

  // Show loading state
  player.innerHTML = `
    <div class="audio-controls">
      <button class="play-btn" id="play-btn" disabled>${PLAY_ICON}</button>
      <div class="audio-loading" id="audio-status">Chargement de la narration...</div>
    </div>
  `;

  try {
    const res = await fetch(`/api/chapter/${index}/audio?voice=${encodeURIComponent(currentVoice)}`);
    if (!res.ok) throw new Error('Audio generation failed');

    // Read cached voices from header
    let cachedVoices = [];
    try { cachedVoices = JSON.parse(res.headers.get('X-Cached-Voices') || '[]'); } catch {}

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    audio = new Audio(url);
    audioLoaded = true;

    // Build voice selector HTML if multiple cached voices
    let voiceSelectorHTML = '';
    if (cachedVoices.length >= 2) {
      const chips = cachedVoices.map(v => {
        const label = allVoices.find(av => av.id === v)?.label || v;
        return `<button class="voice-chip ${v === currentVoice ? 'active' : ''}" data-voice="${v}">${label}</button>`;
      }).join('');
      voiceSelectorHTML = `<div class="voice-selector">${chips}</div>`;
    }

    // Replace with progress controls + optional voice selector
    player.innerHTML = `
      <div class="audio-controls">
        <button class="play-btn" id="play-btn">${PLAY_ICON}</button>
        <div class="progress-wrapper">
          <div class="progress-bar" id="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="time-display">
            <span id="time-current">0:00</span>
            <span id="time-total">--:--</span>
          </div>
        </div>
      </div>
      ${voiceSelectorHTML}
    `;

    const newPlayBtn = document.getElementById('play-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressFill = document.getElementById('progress-fill');
    const timeCurrent = document.getElementById('time-current');
    const timeTotal = document.getElementById('time-total');

    audio.addEventListener('loadedmetadata', () => {
      if (!audio) return;
      timeTotal.textContent = formatTime(audio.duration);
    });

    // Autoplay
    if (autoplayEnabled) {
      audio.play().then(() => {
        if (!audio) return;
        isPlaying = true;
        newPlayBtn.innerHTML = PAUSE_ICON;
      }).catch(e => {
        console.warn('Autoplay blocked by browser:', e.message);
      });
    }

    audio.addEventListener('timeupdate', () => {
      if (!audio || !audio.duration) return;
      const pct = (audio.currentTime / audio.duration) * 100;
      progressFill.style.width = pct + '%';
      timeCurrent.textContent = formatTime(audio.currentTime);
    });

    audio.addEventListener('ended', () => {
      isPlaying = false;
      newPlayBtn.innerHTML = PLAY_ICON;
      progressFill.style.width = '0%';
    });

    newPlayBtn.addEventListener('click', () => {
      if (isPlaying) {
        audio.pause();
        isPlaying = false;
        newPlayBtn.innerHTML = PLAY_ICON;
      } else {
        audio.play();
        isPlaying = true;
        newPlayBtn.innerHTML = PAUSE_ICON;
      }
    });

    progressBar.addEventListener('click', (e) => {
      const rect = progressBar.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      audio.currentTime = pct * audio.duration;
    });

    // Voice selector click handlers
    player.querySelectorAll('.voice-selector .voice-chip').forEach(btn => {
      btn.addEventListener('click', async () => {
        currentVoice = btn.dataset.voice;
        await fetch('/api/voice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ voice: currentVoice }),
        });
        updateVoiceMenu();
        loadChapterAudio(index);
      });
    });

  } catch (err) {
    const statusEl = document.getElementById('audio-status');
    if (statusEl) {
      statusEl.className = 'audio-error';
      statusEl.textContent = 'Narration indisponible';
    }
  }
}

function formatTime(seconds) {
  if (!seconds || isNaN(seconds)) return '0:00';
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${m}:${s.toString().padStart(2, '0')}`;
}

// --- WebSocket for live updates ---
function connectWS() {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const ws = new WebSocket(`${protocol}//${location.host}`);

  ws.addEventListener('message', (event) => {
    const data = JSON.parse(event.data);
    if (data.type === 'story-updated') {
      // Update story data
      story.chapters = data.chapters;

      // Show toast if we're on the last chapter
      if (currentIndex === story.chapters.length - 2) {
        showToast(data.chapterCount);
      }

      // Update navigation buttons
      const nextBtn = document.getElementById('next-btn');
      const navIndicator = document.querySelector('.nav-indicator');
      if (nextBtn && currentIndex < story.chapters.length - 1) {
        nextBtn.disabled = false;
      }
      if (navIndicator) {
        navIndicator.textContent = `Chapitre ${currentIndex + 1} / ${story.chapters.length}`;
      }

      // Update menu chapter list
      updateChapterList();
    }
  });

  ws.addEventListener('close', () => {
    // Reconnect after a delay
    setTimeout(connectWS, 3000);
  });
}

function showToast(chapterCount) {
  toast.textContent = `Nouveau chapitre disponible (${chapterCount} chapitres)`;
  toast.classList.add('visible');
  toast.onclick = () => {
    toast.classList.remove('visible');
    renderChapter(story.chapters.length - 1);
  };
  setTimeout(() => toast.classList.remove('visible'), 8000);
}

// --- Keyboard navigation ---
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && menuPanel.classList.contains('open')) {
    toggleMenu();
  } else if (e.key === 'ArrowRight' && currentIndex < story.chapters.length - 1) {
    renderChapter(currentIndex + 1);
  } else if (e.key === 'ArrowLeft' && currentIndex > 0) {
    renderChapter(currentIndex - 1);
  } else if (e.key === ' ' && audioLoaded && audio) {
    e.preventDefault();
    const playBtn = document.getElementById('play-btn');
    if (isPlaying) {
      audio.pause();
      isPlaying = false;
      playBtn.innerHTML = PLAY_ICON;
    } else {
      audio.play();
      isPlaying = true;
      playBtn.innerHTML = PAUSE_ICON;
    }
  }
});

// --- Init ---
loadStory();
connectWS();
</script>
</body>
</html>
